services:
  app:
    profiles: [ production, test ]
    image: $MONITORENV_IMAGE:$MONITORENV_VERSION
    container_name: monitorenv_backend
    user: "monitorenv:${MONITORENV_LOGS_AND_BACKUPS_GID}"
    environment:
      - ENV_DB_URL=jdbc:postgresql://db:5432/$POSTGRES_DB?user=$POSTGRES_USER&password=$POSTGRES_PASSWORD
      - FLYWAY_MIGRATION_PATH=${FLYWAY_MIGRATION_PATH}
      - MONITORENV_HTTP_PROXY_HOST=${MONITORENV_HTTP_PROXY_HOST}
      - MONITORENV_HTTP_PROXY_PORT=${MONITORENV_HTTP_PROXY_PORT}
      - MONITORENV_HTTP_NON_PROXY_HOSTS=${MONITORENV_HTTP_NON_PROXY_HOSTS}
      - MONITORENV_JVM_OPTIONS=${MONITORENV_JVM_OPTIONS}
      - FRONTEND_GEOSERVER_NAMESPACE=${FRONTEND_GEOSERVER_NAMESPACE}
      - FRONTEND_GEOSERVER_REMOTE_URL=${FRONTEND_GEOSERVER_REMOTE_URL}
      - FRONTEND_GOOGLEMAPS_API_KEY=${FRONTEND_GOOGLEMAPS_API_KEY}
      - FRONTEND_MATOMO_URL=${MONITORENV_MATOMO_URL}
      - FRONTEND_MATOMO_ID=${MONITORENV_MATOMO_ID}
      - FRONTEND_MAPBOX_KEY=${FRONTEND_MAPBOX_KEY}
      - FRONTEND_METABASE_URL=${FRONTEND_METABASE_URL}
      - FRONTEND_MONITORENV_VERSION=${MONITORENV_VERSION}
      - FRONTEND_SENTRY_DSN=${SENTRY_DSN}
      - FRONTEND_SENTRY_ENV=${ENVIRONMENT}
      - FRONTEND_SENTRY_AUTH_TOKEN=${FRONTEND_SENTRY_AUTH_TOKEN}
      - FRONTEND_SENTRY_TRACING_ORIGIN=${FRONTEND_SENTRY_TRACING_ORIGIN}
      - FRONTEND_SHOM_KEY=${FRONTEND_SHOM_KEY}
      - FRONTEND_MISSION_FORM_AUTO_UPDATE=${FRONTEND_MISSION_FORM_AUTO_UPDATE}
      - FRONTEND_MISSION_FORM_AUTO_SAVE_ENABLED=${FRONTEND_MISSION_FORM_AUTO_SAVE_ENABLED}
      - FRONTEND_REPORTING_FORM_AUTO_SAVE_ENABLED=${FRONTEND_REPORTING_FORM_AUTO_SAVE_ENABLED}
      - FRONTEND_REPORTING_FORM_AUTO_UPDATE=${FRONTEND_REPORTING_FORM_AUTO_UPDATE}
      - FRONTEND_VESSELS_ENABLED=${FRONTEND_VESSELS_ENABLED}
      - FRONTEND_OIDC_ENABLED=${MONITORENV_OIDC_ENABLED}
      - MONITORENV_LEGICEM_ID=${MONITORENV_LEGICEM_ID}
      - MONITORENV_LEGICEM_PASSWORD=${MONITORENV_LEGICEM_PASSWORD}
      - MONITORENV_EXT_ID=${MONITORENV_EXT_ID}
      - MONITORENV_EXT_PASSWORD=${MONITORENV_EXT_PASSWORD}
      - MONITORENV_KAFKA_AIS_ENABLED=${MONITORENV_KAFKA_AIS_ENABLED}
      - MONITORENV_KAFKA_AIS_PRODUCER_ENABLED=${MONITORENV_KAFKA_AIS_PRODUCER_ENABLED}
      - MONITORENV_KAFKA_AIS_SERVERS=${MONITORENV_KAFKA_AIS_SERVERS}
      - MONITORENV_KAFKA_AIS_GROUP_ID=${MONITORENV_KAFKA_AIS_GROUP_ID}
      - MONITORENV_KAFKA_AIS_KEYSTORE=${MONITORENV_KAFKA_AIS_KEYSTORE}
      - MONITORENV_KAFKA_AIS_KEYSTORE_PASSWORD=${MONITORENV_KAFKA_AIS_KEYSTORE_PASSWORD}
      - MONITORENV_KAFKA_AIS_KEY_PASSWORD=${MONITORENV_KAFKA_AIS_KEY_PASSWORD}
      - MONITORENV_KAFKA_AIS_TRUSTSTORE=${MONITORENV_KAFKA_AIS_TRUSTSTORE}
      - MONITORENV_KAFKA_AIS_TRUSTSTORE_PASSWORD=${MONITORENV_KAFKA_AIS_TRUSTSTORE_PASSWORD}
      - MONITORENV_KAFKA_AIS_BATCH_SIZE=${MONITORENV_KAFKA_AIS_BATCH_SIZE}
      - MONITORENV_KAFKA_AIS_TOPIC=${MONITORENV_KAFKA_AIS_TOPIC}
      - MONITORENV_KAFKA_AIS_TIMEOUT=${MONITORENV_KAFKA_AIS_TIMEOUT}
      - MONITORENV_OIDC_ENABLED=${MONITORENV_OIDC_ENABLED}
      - MONITORENV_OIDC_LOGIN_URL=${MONITORENV_OIDC_LOGIN_URL}
      - MONITORENV_OIDC_SUCCESS_URL=${MONITORENV_OIDC_SUCCESS_URL}
      - MONITORENV_OIDC_ERROR_URL=${MONITORENV_OIDC_ERROR_URL}
      - MONITORENV_OIDC_AUTHORIZED_EMAIL_DOMAINS=${MONITORENV_OIDC_AUTHORIZED_EMAIL_DOMAINS}
      - MONITORENV_OIDC_BYPASS_DOMAINS_FILTER=${MONITORENV_OIDC_BYPASS_DOMAINS_FILTER}
      - MONITORENV_OIDC_CLIENT_ID=${MONITORENV_OIDC_CLIENT_ID}
      - MONITORENV_OIDC_CLIENT_SECRET=${MONITORENV_OIDC_CLIENT_SECRET}
      - MONITORENV_OIDC_REDIRECT_URI=${MONITORENV_OIDC_REDIRECT_URI}
      - MONITORENV_OIDC_ISSUER_URI=${MONITORENV_OIDC_ISSUER_URI}
      - MONITORENV_OIDC_AUTHORIZATION_URI=${MONITORENV_OIDC_AUTHORIZATION_URI}
      - MONITORENV_OIDC_TOKEN_URI=${MONITORENV_OIDC_TOKEN_URI}
      - MONITORENV_OIDC_USER_INFO_URI=${MONITORENV_OIDC_USER_INFO_URI}
      - MONITORENV_OIDC_JWK_SET_URI=${MONITORENV_OIDC_JWK_SET_URI}
      - MONITORENV_OIDC_PROVIDER=${MONITORENV_OIDC_PROVIDER}
      - MONITORENV_URL=${MONITORENV_URL}
      - MONITORFISH_API_KEY=${MONITORFISH_API_KEY}
      - MONITORFISH_URL=${MONITORFISH_URL}
      - SENTRY_DSN=${SENTRY_DSN}
      - ENVIRONMENT=${ENVIRONMENT}
      - MONITORENV_SENTRY_ENABLED=${MONITORENV_SENTRY_ENABLED}
      - RAPPORTNAV_URL=${RAPPORTNAV_URL}
      - MONITORENV_API_KEY=${MONITORENV_API_KEY}
      - MONITORENV_BATCH_SIZE=${MONITORENV_BATCH_SIZE}
    ports:
      - ${BACKEND_HTTP_PORT}:8880
      - 8000:8000
      - 5000:5000
      - 5001:5001
    volumes:
      - "${MONITORENV_LOGS_FOLDER}:/home/monitorenv/logs"
    networks:
      - backend_network
    depends_on:
      - db
    restart: always
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "1024m"

  db:
    image: ghcr.io/mtes-mct/monitorenv/monitorenv-database:${DB_VERSION}
    container_name: monitorenv_database
    user: ":${MONITORENV_LOGS_AND_BACKUPS_GID}"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - db-data:/var/lib/postgresql/data
      - "${MONITORENV_BACKUPS_FOLDER}:/opt/monitorenv_backups"
      # TODO: this was in docker-compose.override.yml
      - "${MONITORENV_DATA_FOLDER}:/opt/data"
    ports:
      - ${POSTGRES_PORT}:5432
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 1s
      timeout: 1s
      retries: 30
    networks:
      - backend_network
    restart: always
    command: postgres -c shared_preload_libraries='pg_stat_statements,timescaledb'

  geoserver:
    container_name: monitorenv_geoserver
    profiles: [ dev, production ]
    image: kartoza/geoserver:2.18.0
    environment:
      - GEOSERVER_ADMIN_PASSWORD=${GEOSERVER_ADMIN_PASSWORD}
      - GEOSERVER_ADMIN_USER=${GEOSERVER_ADMIN_USER}
    ports:
      - ${GEOSERVER_PORT}:8080
    volumes:
      - geoserver-data:/opt/geoserver/data_dir
      - geoserver-settings:/settings
    healthcheck:
      test: [ "CMD-SHELL", "curl --fail -s http://localhost:8080/geoserver/index.html || exit 1" ]
      interval: 1m30s
      timeout: 1s
      retries: 30
    networks:
      - backend_network
    restart: always

  keycloak:
    container_name: monitorenv_keycloak
    profiles: [ dev ]
    image: quay.io/keycloak/keycloak:latest
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
    networks:
      - backend_network
    ports:
      - "8085:8080"
    volumes:
      - ./infra/configurations/keycloack:/opt/keycloak/data/import
    command:
      - start-dev
      - --import-realm

  mock-geoserver:
    profiles: [ test ]
    image: wiremock/wiremock:3.8.0
    networks:
      - backend_network
    ports:
      - 8081:8080
    volumes:
      - ./frontend/cypress/mappings/geoserver:/home/wiremock/mappings
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl --fail http://localhost:8080/geoserver/wfs?service=WFS&version=1.1.0&request=GetFeature&typename=monitorenv:regulations&outputFormat=application/json&CQL_FILTER=topic=%27Ouest%20Cotentin%20Bivalves%27%20AND%20zone=%27Praires%20Ouest%20cotentin%27 || exit 1 ",
        ]
      interval: 1s
      timeout: 1s
      retries: 30

  mock-monitorfish:
    profiles: [ dev, test ]
    image: wiremock/wiremock:3.8.0
    networks:
      - backend_network
    ports:
      - 8082:8080
    volumes:
      - ./frontend/cypress/mappings/monitorfish:/home/wiremock/mappings
    healthcheck:
      test: [ "CMD-SHELL", "curl --fail http://localhost:8080/api/v1/mission_actions?missionId=34 || exit 1 " ]
      interval: 1s
      timeout: 1s
      retries: 30

  mock-rapportnav:
    profiles: [ dev, test ]
    image: wiremock/wiremock:3.8.0
    networks:
      - backend_network
    ports:
      - 8083:8080
    volumes:
      - ./frontend/cypress/mappings/rapportnav:/home/wiremock/mappings
    healthcheck:
      test: [ "CMD-SHELL", "curl --fail http://localhost:8080/api/v1/missions/34 || exit 1 " ]
      interval: 1s
      timeout: 1s
      retries: 30

  kafka:
    container_name: kafka
    profiles: [ dev, test ]
    image: confluentinc/cp-kafka:8.1.0
    ports:
      - "9093:9093"
    volumes:
      - ./infra/kafka/certs/kafka/:/etc/kafka/secrets
    environment:
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "SSL:SSL,CONTROLLER:SSL"
      KAFKA_LISTENERS: SSL://0.0.0.0:9093,CONTROLLER://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: SSL://localhost:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_NUM_PARTITIONS: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_BROKER_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_SECURITY_INTER_BROKER_PROTOCOL: SSL
      KAFKA_SSL_KEYSTORE_TYPE: PKCS12
      KAFKA_SSL_KEYSTORE_LOCATION: /etc/kafka/secrets/kafka.p12
      KAFKA_SSL_TRUSTSTORE_LOCATION: /etc/kafka/secrets/kafka-truststore.jks
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.p12
      KAFKA_SSL_KEYSTORE_PASSWORD: changeit
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka-truststore.jks
      KAFKA_SSL_TRUSTSTORE_PASSWORD: changeit
      KAFKA_SSL_KEY_CREDENTIALS: kafka.keypass
      KAFKA_SSL_KEYSTORE_CREDENTIALS: kafka.keypass
      KAFKA_SSL_TRUSTSTORE_CREDENTIALS: kafka.keypass
      KAFKA_SSL_CLIENT_AUTH: required

networks:
  backend_network:

volumes:
  db-data:
    name: ${DB_DATA_VOLUME_NAME}
  geoserver-data:
    driver: local
  geoserver-settings:
    driver: local
